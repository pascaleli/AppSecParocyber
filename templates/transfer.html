{% extends "base.html" %}
{% block title %}Transfer – SecureBank{% endblock %}
{% block content %}
<p style="margin-bottom: 1rem;"><a href="/dashboard" class="btn btn-secondary">← Dashboard</a></p>

<div class="card">
  <h2>New transfer</h2>
  {% if error %}<p class="error">{{ error }}</p>{% endif %}
  <form method="post" action="/transfer">
    <div class="form-group">
      <label for="from_account_id">From account</label>
      <select id="from_account_id" name="from_account_id" required>
        <option value="">Select account</option>
        {% for a in accounts %}
        <option value="{{ a.id }}">{{ a.name }} (****{{ a.account_number[-4:] }}) – ${{ a.balance }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="form-group">
      <label for="payee_search">Find payee (by name or username)</label>
      <input type="text" id="payee_search" placeholder="Type to search..." autocomplete="off">
      <div id="payee_results" class="muted" style="margin-top: 0.25rem; font-size: 0.9rem;"></div>
    </div>
    <div class="form-group">
      <label for="to_account_id">To account ID</label>
      <input type="number" id="to_account_id" name="to_account_id" placeholder="e.g. 2" required min="1">
      <span class="muted">Select a payee above or enter destination account ID.</span>
    </div>
    <div class="form-group">
      <label for="amount">Amount ($)</label>
      <input type="number" id="amount" name="amount" step="0.01" min="0.01" required>
    </div>
    <div class="form-group">
      <label for="memo">Memo (optional)</label>
      <textarea id="memo" name="memo" rows="2" maxlength="500"></textarea>
    </div>
    <button type="submit" class="btn">Send transfer</button>
  </form>
</div>
<script>
(function() {
  var q = document.getElementById('payee_search');
  var out = document.getElementById('payee_results');
  var toId = document.getElementById('to_account_id');
  var timer;
  q.addEventListener('input', function() {
    clearTimeout(timer);
    var val = q.value.trim();
    if (val.length < 2) { out.textContent = ''; return; }
    timer = setTimeout(function() {
      fetch('/api/users/search?q=' + encodeURIComponent(val))
        .then(function(r) { return r.json(); })
        .then(function(data) {
          if (data.error) { out.innerHTML = 'Error: ' + data.error; return; }
          if (data.length === 0) { out.textContent = 'No results'; return; }
          out.innerHTML = 'Users: ' + data.map(function(u) {
            return u.full_name + ' (@' + u.username + ', id ' + u.id + ')';
          }).join('; ');
        })
        .catch(function() { out.textContent = 'Search failed'; });
    }, 200);
  });
})();
</script>
{% endblock %}
