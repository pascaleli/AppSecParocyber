{% extends "base.html" %}
{% block title %}Transfer – ParoCyberBank{% endblock %}
{% block content %}
<p style="margin-bottom: 1rem;"><a href="/dashboard" class="btn btn-secondary">← Dashboard</a></p>

<div class="card">
  <h2>New transfer</h2>
  {% if error %}<p class="error">{{ error }}</p>{% endif %}

  <div class="form-group">
    <label for="payee_search">Find payee</label>
    {% if saved_payees %}
    <p class="muted">Choose a saved payee or search below.</p>
    <div id="saved_payees">
      {% for p in saved_payees %}
      <span class="payee-chip" data-user-id="{{ p.payee_user_id }}" data-label="{{ p.label }}">{{ p.label }} ({{ p.full_name }})</span>
      {% endfor %}
    </div>
    {% endif %}
    <p class="muted">Type a few characters (e.g. <strong>ali</strong>, <strong>bob</strong>, <strong>char</strong>) and click Search or wait for results. Demo users: alice, bob, charlie.</p>
    <div style="display: flex; gap: 0.5rem; align-items: center; margin-top: 0.5rem;">
      <input type="text" id="payee_search" placeholder="Search by name or username..." autocomplete="off" style="flex: 1;">
      <button type="button" id="payee_search_btn" class="btn btn-small">Search</button>
    </div>
    <div id="payee_results" class="muted" style="margin-top: 0.25rem; font-size: 0.9rem;"></div>
    <input type="hidden" id="selected_payee_id" name="selected_payee_id" value="">
    <p id="selected_payee_label" class="muted" style="margin-top: 0.5rem;"></p>
  </div>

  <form method="post" action="/transfer" id="transfer_form">
    <div class="form-group">
      <label for="from_account_id">From account</label>
      <select id="from_account_id" name="from_account_id" required>
        <option value="">Select your account</option>
        {% for a in accounts %}
        <option value="{{ a.id }}">{{ a.name }} ****{{ a.account_number[-4:] }} – ${{ a.balance }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="form-group">
      <label for="to_account_id">To account</label>
      <select id="to_account_id" name="to_account_id" required title="Search for a payee (e.g. alice, bob, charlie) and click a result to fill this list.">
        <option value="">First search or select a payee above</option>
      </select>
      <span class="muted">Pick the destination account (payee may have several).</span>
      <p id="to_account_hint" class="error" style="display: none; margin-top: 0.5rem;"></p>
    </div>
    <div class="form-group">
      <label for="amount">Amount ($)</label>
      <input type="number" id="amount" name="amount" step="0.01" min="0.01" required>
    </div>
    <div class="form-group">
      <label for="memo">Memo (optional)</label>
      <textarea id="memo" name="memo" rows="2" maxlength="500"></textarea>
    </div>
    <button type="submit" class="btn">Send transfer</button>
  </form>
</div>

<script>
(function() {
  var payeeSearch = document.getElementById('payee_search');
  var payeeResults = document.getElementById('payee_results');
  var selectedPayeeId = document.getElementById('selected_payee_id');
  var selectedPayeeLabel = document.getElementById('selected_payee_label');
  var toAccountSelect = document.getElementById('to_account_id');
  var timer;

  function clearPayee() {
    selectedPayeeId.value = '';
    selectedPayeeLabel.textContent = '';
    toAccountSelect.innerHTML = '<option value="">First search or select a payee above</option>';
  }

  function setPayee(userId, label) {
    selectedPayeeId.value = userId;
    selectedPayeeLabel.textContent = 'Sending to: ' + label;
    fetch('/api/users/' + userId + '/accounts')
      .then(function(r) { return r.json(); })
      .then(function(accounts) {
        toAccountSelect.innerHTML = '<option value="">Select account</option>';
        accounts.forEach(function(a) {
          var opt = document.createElement('option');
          opt.value = a.id;
          opt.textContent = a.name + ' ****' + a.account_number.slice(-4) + ' – $' + a.balance;
          toAccountSelect.appendChild(opt);
        });
      })
      .catch(function() { toAccountSelect.innerHTML = '<option value="">Error loading accounts</option>'; });
  }

  function doSearch() {
    var val = payeeSearch.value.trim();
    if (val.length < 2) { payeeResults.innerHTML = 'Type at least 2 characters'; return; }
    clearPayee();
    payeeResults.innerHTML = 'Searching...';
    fetch('/api/users/search?q=' + encodeURIComponent(val))
      .then(function(r) { return r.json(); })
      .then(function(data) {
        if (data.error) { payeeResults.innerHTML = 'Error: ' + data.error; return; }
        if (data.length === 0) { payeeResults.innerHTML = 'No results. Try <strong>ali</strong>, <strong>bob</strong>, or <strong>char</strong> (demo users).'; return; }
        payeeResults.innerHTML = '';
        data.forEach(function(u) {
          var btn = document.createElement('button');
          btn.type = 'button';
          btn.className = 'payee-chip';
          btn.textContent = u.full_name + ' (@' + u.username + ')';
          btn.style.marginRight = '0.5rem';
          btn.onclick = function() { setPayee(u.id, u.full_name); payeeResults.innerHTML = ''; };
          payeeResults.appendChild(btn);
        });
      })
      .catch(function() { payeeResults.innerHTML = 'Search failed'; });
  }

  payeeSearch.addEventListener('input', function() {
    clearPayee();
    clearTimeout(timer);
    var val = payeeSearch.value.trim();
    if (val.length < 2) { payeeResults.innerHTML = ''; return; }
    timer = setTimeout(doSearch, 200);
  });

  var searchBtn = document.getElementById('payee_search_btn');
  if (searchBtn) searchBtn.addEventListener('click', doSearch);

  var form = document.getElementById('transfer_form');
  var toAccountHint = document.getElementById('to_account_hint');
  if (form) {
    form.addEventListener('submit', function(e) {
      var val = toAccountSelect.value;
      if (!val || val === '') {
        e.preventDefault();
        toAccountHint.textContent = 'Please search for a payee (e.g. alice, bob or charlie) and click a name in the results. Then choose a "To account" from the list.';
        toAccountHint.style.display = 'block';
        toAccountSelect.focus();
        return false;
      }
      toAccountHint.style.display = 'none';
    });
  }
  toAccountSelect.addEventListener('change', function() { if (toAccountHint) toAccountHint.style.display = 'none'; });

  var saved = document.getElementById('saved_payees');
  if (saved) {
    saved.querySelectorAll('.payee-chip').forEach(function(chip) {
      chip.onclick = function() {
        setPayee(chip.getAttribute('data-user-id'), chip.getAttribute('data-label'));
      };
    });
  }
})();
</script>
{% endblock %}
